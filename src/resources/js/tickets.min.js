var ticketHeaderImage=window.ticketHeaderImage||{};!function(t,e,i){"use strict";ticketHeaderImage={uploader:function(){var t=wp.media({title:HeaderImageData.title,multiple:!1,library:{type:"image"},button:{text:HeaderImageData.button}});return t.on("close",function(){var e=t.state().get("selection").toJSON();e.length&&ticketHeaderImage.render(e[0])}),t.open(),!1},render:function(t){e("#tribe_ticket_header_preview").html(ticketHeaderImage.imgHTML(t)),e("#tribe_ticket_header_image_id").val(t.id),e("#tribe_ticket_header_remove").show()},imgHTML:function(t){var e='<img src="'+t.url+'" ';return e+='width="'+t.width+'" ',e+='height="'+t.height+'" ',e+="/>"}},e(document).ready(function(){function i(){return l.prop("checked")}function a(){g=!0,o.trigger("set-global-stock-fields.tribe")}function r(){e("tr.ticket_advanced").hide(),e("tr.ticket_advanced_"+n()+":not(.sale_price)").show(),o.trigger("set-advanced-fields.tribe"),e(document.getElementById("tribetickets")).trigger("ticket-provider-changed.tribe")}function n(){var t=e('input[name="ticket_provider"]:checked');return t.length>0?t[0].value:""}function c(){var t=o.find("tr.ticket_advanced.history");if(t.length){var e=t.find("a.toggle-history"),i=e.find("span"),a=t.find("ul");t.find("a.toggle-history").click(function(t){return i.toggle(),a.toggle(),t.stopPropagation(),!1})}}var d=e("#tribe-event-datepickers"),o=e("#tribetickets"),s=e("#event_tickets"),l=e("#tribe-tickets-enable-global-stock"),_=e("#tribe-tickets-global-stock-level"),g=!1,k=e("html, body"),p=0;o.on({"spin.tribe":function(t,i){("undefined"==typeof i||e.inArray(i,["start","stop"]))&&(i="stop"),"stop"===i?s.css("opacity","1").find("#tribe-loading").hide():s.css("opacity","0.5").find("#tribe-loading").show()},"clear.tribe":function(){var t=e(this),i=t.find("#ticket_form"),a=i.find("tr:not(.event-wide-settings)");t.find("a#ticket_form_toggle").show(),a.find('input:not(:button):not(:radio):not(:checkbox):not([type="hidden"]), textarea').val(""),a.find("input:checkbox").attr("checked",!1),a.find("#ticket_id").val(""),t.find('#ticket_form input[name="show_attendee_info"]').prop("checked",!1).change(),t.find("input[data-default-value]").each(function(){var t=e(this);t.val(t.data("default-value"))}),t.find("#ticket_start_date").datepicker("option","maxDate",null),t.find("#ticket_end_date").datepicker("option","minDate",null),t.find(".ticket_start_time, .ticket_end_time, .ticket.sale_price").hide(),t.find("#ticket_price").removeProp("disabled").siblings(".no-update-message").html("").hide().end().siblings(".description").show(),e("#tribe-tickets-attendee-sortables").empty(),e(".tribe-tickets-attendee-saved-fields").show(),i.hide()},"focus.tribe":function(){k.animate({scrollTop:s.offset().top-50},500)},"edit-tickets-complete.tribe":function(){c()},"set-advanced-fields.tribe":function(){var t=e(this),i=t.find("#ticket_form"),a=i.find("tr.ticket_advanced:not(.ticket_advanced_meta)").find("input, select, textarea"),r=i.find("#ticket_provider:checked").val();a.each(function(){var t=e(this);t.attr("name")&&t.data("name",t.attr("name")).attr({name:"",id:""}),t.closest("tr").hasClass("ticket_advanced_"+r)&&t.data("name")&&0===t.attr("name").length&&t.attr({name:t.data("name"),id:t.data("name")})}),o.trigger("set-global-stock-fields.tribe"),e("#ticket_global_stock").change(function(){o.trigger("set-global-stock-fields.tribe")})},"set-global-stock-fields.tribe":function(){var t=n(),a=e(this).find("#ticket_form").find(".ticket_advanced_"+t);if(!(a.length<1)){var r=a.filter(".stock"),c=a.filter(".global-stock-mode"),d=c.filter(".sales-cap-field"),o=e("#ticket_global_stock").val(),s=i();if(_.toggle(s),c.toggle(i()),r.toggle(!s),s)switch(o){case"global":d.hide(),r.hide();break;case"capped":d.show(),r.hide();break;case"own":d.hide(),r.show()}}}}),d.length&&(p=d.data("startofweek"));var f={dateFormat:"yy-mm-dd",showAnim:"fadeIn",changeMonth:!0,changeYear:!0,numberOfMonths:3,firstDay:p,showButtonPanel:!0,onChange:function(){},onSelect:function(t,i){var a=e.datepicker.parseDate("yy-mm-dd",t);"ticket_start_date"===i.id?(e("#ticket_end_date").datepicker("option","minDate",a),a?e(".ticket_start_time").show():e(".ticket_start_time").hide()):(e("#ticket_start_date").datepicker("option","maxDate",a),a?e(".ticket_end_time").show():e(".ticket_end_time").hide())}};e("#ticket_start_date").datepicker(f).keyup(function(t){8!==t.keyCode&&46!==t.keyCode||e.datepicker._clearDate(this)}),e("#ticket_end_date").datepicker(f).keyup(function(t){8!==t.keyCode&&46!==t.keyCode||e.datepicker._clearDate(this)}),l.change(a),l.trigger("change"),g=!1,e("input[name=ticket_provider]:radio").change(function(){r()}),e("input[name=ticket_provider]:checked").each(function(){r()}),e("a#ticket_form_toggle").click(function(t){e("h4.ticket_form_title_edit").hide(),e("h4.ticket_form_title_add").show(),e(this).hide(),o.trigger("clear.tribe").trigger("set-advanced-fields.tribe").trigger("focus.tribe"),e("#ticket_form").show(),e(document.getElementById("tribetickets")).trigger("ticket-provider-changed.tribe"),t.preventDefault()}),e("#ticket_form_cancel").click(function(){o.trigger("clear.tribe").trigger("set-advanced-fields.tribe").trigger("focus.tribe")}),e("#ticket_form_save").click(function(t){var i=e("#ticket_form_table"),a=i.find("#ticket_provider:checked").val(),r=i.find(".ticket, .ticket_advanced_meta, .ticket_advanced_"+a);o.trigger("save-ticket.tribe",t).trigger("spin.tribe","start");var n={action:"tribe-ticket-add-"+e("input[name=ticket_provider]:checked").val(),formdata:r.find(".ticket_field").serialize(),post_ID:e("#post_ID").val(),nonce:TribeTickets.add_ticket_nonce};e.post(ajaxurl,n,function(t){o.trigger("saved-ticket.tribe",t),t.success&&(o.trigger("clear.tribe"),e("td.ticket_list_container").empty().html(t.data.html),e(".ticket_time").hide())},"json").complete(function(){o.trigger("spin.tribe","stop").trigger("focus.tribe")})}),o.on("click",".ticket_delete",function(t){if(!confirm(tribe_ticket_notices.confirm_alert))return!1;t.preventDefault(),o.trigger("delete-ticket.tribe",t).trigger("spin.tribe","start");var i={action:"tribe-ticket-delete-"+e(this).attr("attr-provider"),post_ID:e("#post_ID").val(),ticket_id:e(this).attr("attr-ticket-id"),nonce:TribeTickets.remove_ticket_nonce};e.post(ajaxurl,i,function(t){o.trigger("deleted-ticket.tribe",t),t.success&&(o.trigger("clear.tribe"),e("td.ticket_list_container").empty().html(t.data))},"json").complete(function(){o.trigger("spin.tribe","stop")})}),o.on("click",".ticket_edit",function(t){t.preventDefault(),e("h4.ticket_form_title_edit").show(),e("h4.ticket_form_title_add").hide(),o.trigger("spin.tribe","start");var i={action:"tribe-ticket-edit-"+e(this).attr("attr-provider"),post_ID:e("#post_ID").val(),ticket_id:e(this).attr("attr-ticket-id"),nonce:TribeTickets.edit_ticket_nonce};e.post(ajaxurl,i,function(t){o.trigger("clear.tribe").trigger("set-advanced-fields.tribe").trigger("edit-ticket.tribe",t);var i=t.data.price,a=i,r=!1;"undefined"!=typeof t.data.on_sale&&t.data.on_sale&&(r=!0,i=t.data.regular_price),e("#ticket_id").val(t.data.ID),e("#ticket_name").val(t.data.name),e("#ticket_description").val(t.data.description),r&&e(".ticket_advanced_"+t.data.provider_class+".sale_price").show();var n=t.data.start_date.substring(0,10),c=t.data.end_date.substring(0,10);e("#ticket_start_date").val(n),e("#ticket_end_date").val(c);var d=e(document.getElementById("ticket_start_meridian")),s=e(document.getElementById("ticket_end_meridian"));if(t.data.start_date){var l=parseInt(t.data.start_date.substring(11,13)),_="am";l>12&&d.length&&(_="pm",l=parseInt(l)-12,l=("0"+l).slice(-2)),12===l&&(_="pm"),0===l&&"am"===_&&(l=12),l=l.toString(),1===l.length&&(l="0"+l),e("#ticket_start_hour").val(l),e("#ticket_start_meridian").val(_),e(".ticket_start_time").show()}if(t.data.end_date){var g=parseInt(t.data.end_date.substring(11,13)),k="am";g>12&&s.length&&(k="pm",g=parseInt(g)-12,g=("0"+g).slice(-2)),12===g&&(k="pm"),0===g&&"am"===k&&(g=12),g=g.toString(),1===g.length&&(g="0"+g),e("#ticket_end_hour").val(g),e("#ticket_end_meridian").val(k),e("#ticket_start_minute").val(t.data.start_date.substring(14,16)),e("#ticket_end_minute").val(t.data.end_date.substring(14,16)),e(".ticket_end_time").show()}var p=e("tr.ticket_advanced input");p.data("name",p.attr("name")).attr({name:"",id:""}),e("tr.ticket_advanced").remove(),e("tr.ticket.bottom").before(t.data.advanced_fields),e("input:radio[name=ticket_provider]").filter("[value="+t.data.provider_class+"]").click(),e("input[name=ticket_provider]:radio").change();var f=o.find("#ticket_price");f.val(i),"undefined"!=typeof t.data.disallow_update_price_message?f.siblings(".no-update-message").html(t.data.disallow_update_price_message):f.siblings(".no-update-message").html(""),"undefined"==typeof t.data.can_update_price||t.data.can_update_price?(f.removeProp("disabled"),f.siblings(".description").show(),f.siblings(".no-update-message").hide()):(f.prop("disabled","disabled"),f.siblings(".description").hide(),f.siblings(".no-update-message").show());var m=o.find("#ticket_sale_price");r?m.val(a).closest("tr").show():m.closest("tr").hide(),"undefined"!=typeof t.data.purchase_limit&&t.data.purchase_limit&&e("#ticket_purchase_limit").val(t.data.purchase_limit),o.find(".tribe-bumpdown-trigger").bumpdown(),e("a#ticket_form_toggle").hide(),e("#ticket_form").show(),o.trigger("set-advanced-fields.tribe").trigger("edit-ticket.tribe")},"json").complete(function(){o.trigger("spin.tribe","stop").trigger("focus.tribe").trigger("edit-tickets-complete.tribe")})}).on("click","#tribe_ticket_header_image",function(t){t.preventDefault(),ticketHeaderImage.uploader("","")}).on("keyup","#ticket_price",function(t){t.preventDefault(),console.log("changes here");var i,a=price_format.decimal;price_format.decimal_error;i=new RegExp("[^-0-9%\\"+a+"]+","gi");var r=e(this).val(),n=r.replace(i,"");r!==n?(console.log("new value"),e(this).val(n)):console.log("no change")});var m=e("#tribe_ticket_header_remove"),h=e("#tribe_ticket_header_preview");if(h.find("img").length&&m.show(),_.change(function(){g=!0}),e('input[type="submit"]').click(function(){g=!1}),e(t).on("beforeunload",function(){if(g)return tribe_global_stock_admin_ui.nav_away_msg}),e("body").on("click","#tribe_ticket_header_remove",function(t){t.preventDefault(),h.html(""),m.hide(),e("#tribe_ticket_header_image_id").val("")}),e("#tribe_ticket_header_preview img").length){var u=e("#tribe_ticket_header_preview img");u.removeAttr("width").removeAttr("height"),o.width()<u.width()&&u.css("width","95%")}})}(window,jQuery);